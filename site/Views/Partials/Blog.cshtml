@inherits Umbraco.Web.Mvc.UmbracoTemplatePage

@{
    var posts = Model.Content.Children.Where(x => x.DocumentTypeAlias.Equals("Post") && x.IsVisible()).OrderByDescending(x => Helpers.PostDate(x));
}

<div id="top" class="page-content-anchor">&nbsp;</div>
@if (posts.Any())
{
    var perPage = 10;
    if (Model.Content.HasValue("postsPerPage"))
    {
        perPage = Model.Content.GetPropertyValue<int>("postsPerPage");
    }

    var page = 1;
    int.TryParse(Request.QueryString["page"], out page);
    var totalPages = (int)Math.Ceiling((double)posts.Count() / (double)perPage);

    if (page > totalPages)
    {
        page = totalPages;
    }
    else if (page < 1)
    {
        page = 1;
    }

    <select onchange="window.location=this.value">
        <option value="@Model.Content.Url">Select a category</option>
        @{
            var categories = Model.Content.Children.Where(x => x.DocumentTypeAlias.Equals("Categories") && x.IsVisible());
            if(categories.Any())
            {
                var categoryList = categories.First().Children.Where(x => x.DocumentTypeAlias == "Category" && x.IsVisible());
                if (categoryList.Any()) {
                    foreach (var category in categoryList)
                    {
                        <option value="@category.Url">@category.Name</option>
                    }
                }
            }
        }
    </select>
    
    <div class="blog-post-excerpts">
        @foreach (var post in posts.Skip((page - 1) * perPage).Take(perPage))
        {
        <div class="blog-post-excerpt">
            <h2><a href="@post.Url">@post.Name</a></h2>
            <ul class="blog-post-meta">
                <li>@Helpers.PostDate(post).ToString("MM/dd/yyyy")</li>
                @if (post.HasValue("author"))
                {
                    <li>@Helpers.AuthorName(Umbraco, post.GetPropertyValue("author"))</li>
                }
                @if (post.HasValue("categories"))
                {
                    <li>@Helpers.CategoryList(Umbraco, Html, post.GetPropertyValue("categories"))</li>
                }
            </ul>
            <br />
            @{var description = post.GetPropertyValue("shortDescription");}
            @if (null != description)
            {
                string desc = description.ToString();
                if (desc.Length > 260)
                {
                    desc = desc.Substring(0, 260).TrimEnd(' ') + "...";
                }

                @desc
            }
        </div>
        }
    </div>
    
    @Helpers.Pagination(page, totalPages, perPage, Html)
}
else
{
    @(Model.Content.HasValue("noPostsMessage") ? Model.Content.GetPropertyValue("noPostsMessage").ToString() : "There are no posts to show at this moment.");
}